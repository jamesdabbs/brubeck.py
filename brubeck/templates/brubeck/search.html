{% extends "brubeck/base.html" %}
{% load bootstrap %}

{% block title %}Search{% endblock %}

{% block content %}
<section id="search">
    <form action="" method="GET">
        <div class="control-group">
            <div class="controls">
                {{ form.q|bootstrap:"span8 no-label" }}
            </div>
        </div>
        <button class="btn btn-primary">Search</button>
    </form>
</section>

<section>
{% if results %}
    {% for desc, obj_list in results %}
        <h3>{{ desc }}</h3>
        {% if obj_list %}
        <ul>
            {% for obj in obj_list %}
            {# obj could be an object or an error string #}
            {% if obj.name %}
            <li><a href="{{ obj.get_absolute_url }}">{{ obj.name }}</a></li>
            {% else %}
            <li>{{ obj }}</li>
            {% endif %}
            {% endfor %}
        </ul>
        {% else %}
        <ul><li>None found</li></ul>
        {% endif %}
    {% endfor %}
{% else %}
    <p>You can search by a formula (e.g. Compact + ~Second countable) or by text within descriptions (e.g. by Urysohn's lemma).</p>
{% endif %}
</section>
{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="http://addyosmani.github.com/jquery-ui-bootstrap/css/custom-theme/jquery-ui-1.8.16.custom.css" type="text/css" media="all" />
<!--<link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.18/themes/ui-lightness/jquery-ui.css" type="text/css" media="all" />-->
{% endblock %}

{% block extra_scripts %}
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.18/jquery-ui.min.js"></script>
<script>
$(function() {
    var availableTags = [{% for p in properties %}"{{ p.name|escapejs }}", "~{{ p.name|escapejs }}",{% endfor %}];
    function split( val ) {
        return val.split( /\s*\+\s*/ );
    }
    function extractLast( term ) {
        return split( term ).pop();
    }

    $( "#id_q" ).bind( "keydown", function( event ) {
        // don't navigate away from the field on tab when selecting an item
        if ( event.keyCode === $.ui.keyCode.TAB &&
                $( this ).data( "autocomplete" ).menu.active ) {
            event.preventDefault();
        }
    })
    .autocomplete({
        minLength: 0,
        source: function( request, response ) {
            // delegate back to autocomplete, but extract the last term
            response( $.ui.autocomplete.filter(
                    availableTags, extractLast( request.term ) ) );
        },
        focus: function() {
            // prevent value inserted on focus
            return false;
        },
        select: function( event, ui ) {
            var terms = split( this.value );
            // remove the current input
            terms.pop();
            // add the selected item
            terms.push( ui.item.value );
            // add placeholder to get the comma-and-space at the end
            terms.push( "" );
            this.value = terms.join( " + " );
            return false;
        }
    });
});
</script>
{% endblock %}